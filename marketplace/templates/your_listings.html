{% extends "layout.html" %}

{% block title %}Your Listings - Marketplace{% endblock %}

{% block content %}
<div class="listings-container">
    <!-- Header -->
    <div class="listings-header">
        <h1>üì¶ Your Product Listings</h1>
        <p class="listings-count">Manage all your listed products</p>
        <a href="{{ url_for('upload') }}" class="btn btn-primary">+ Add New Listing</a>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs">
        <button class="filter-tab active" onclick="filterListings('all')">All Products</button>
        <button class="filter-tab" onclick="filterListings('active')">Active Listings</button>
        <button class="filter-tab" onclick="filterListings('deleted')">Deleted Products</button>
    </div>

    <!-- Listings Grid -->
    <div class="listings-grid" id="listingsGrid">
        {% if products and products|length > 0 %}
            {% for product in products %}
            <div class="listing-item" data-status="{{ product.status }}" data-id="{{ product.id }}">
                <span class="listing-status {{ 'status-deleted' if product.status == 'deleted' else 'status-active' }}">
                    {{ product.status|title }}
                </span>
                
                <img src="{{ url_for('static', filename='uploads/' + product.image_filename) }}" alt="{{ product.title }}">
                
                <div class="listing-item-info">
                    <h3>{{ product.title }}</h3>
                    <p class="product-price">${{ "%.2f"|format(product.price) }}</p>
                    <p class="product-category">Category: {{ product.category }}</p>
                    <p class="product-condition">Condition: {{ product.condition }}</p>
                </div>

                <div class="listing-actions">
                    {% if product.status == 'deleted' %}
                        <button class="btn-restore" onclick="restoreProduct({{ product.id }})">
                            üîÑ Restore Product
                        </button>
                    {% else %}
                        <a href="{{ url_for('product_detail', product_id=product.id) }}" class="btn-view">
                            üëÅÔ∏è View Details
                        </a>
                        <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn-edit">
                            ‚úèÔ∏è Edit Product
                        </a>
                        <button class="btn-delete" onclick="confirmDelete({{ product.id }}, '{{ product.title }}')">
                            üóëÔ∏è Delete Listing
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <!-- Empty State -->
            <div class="empty-listings">
                <div class="empty-icon">üì¶</div>
                <h2>No Products Listed Yet</h2>
                <p>Start selling by adding your first product!</p>
                <a href="{{ url_for('upload') }}" class="btn btn-primary">Add Your First Product</a>
            </div>
        {% endif %}
    </div>

    <!-- No Results Message for Filters -->
    <div class="empty-listings" id="noResults" style="display: none;">
        <div class="empty-icon">üîç</div>
        <h2>No Products Found</h2>
        <p>No products match the selected filter.</p>
        <button onclick="filterListings('all')" class="btn btn-primary">Show All Products</button>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-icon">‚ö†Ô∏è</div>
            <h2>Delete Product?</h2>
            <p id="deleteProductName"></p>
        </div>
        <p style="text-align: center; color: #666;">This action will remove the product from active listings. You can restore it later from the "Deleted Products" tab.</p>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
            <button class="modal-btn modal-btn-confirm" onclick="deleteProduct()">Delete</button>
        </div>
    </div>
</div>

<!-- Notification Popup -->
<div class="notification-popup" id="notificationPopup" style="display: none;">
    <div class="notification-content">
        <span class="notification-icon">‚úì</span>
        <span class="notification-text" id="notificationText">Action completed successfully!</span>
        <span class="close-notification" onclick="closeNotification()">‚úï</span>
    </div>
</div>

{% block scripts %}
<script>
    let productToDelete = null;
    let currentFilter = 'all';

    // Filter listings
    function filterListings(status) {
        currentFilter = status;
        const listingItems = document.querySelectorAll('.listing-item');
        const listingsGrid = document.getElementById('listingsGrid');
        const noResults = document.getElementById('noResults');
        const filterTabs = document.querySelectorAll('.filter-tab');
        
        // Update active tab
        filterTabs.forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');
        
        let visibleCount = 0;
        
        listingItems.forEach(item => {
            const itemStatus = item.dataset.status;
            
            if (status === 'all' || 
                (status === 'active' && itemStatus === 'active') ||
                (status === 'deleted' && itemStatus === 'deleted')) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Show/hide no results message
        if (visibleCount === 0) {
            listingsGrid.style.display = 'none';
            noResults.style.display = 'block';
        } else {
            listingsGrid.style.display = 'grid';
            noResults.style.display = 'none';
        }
    }

    // Confirm delete
    function confirmDelete(productId, productName) {
        productToDelete = productId;
        document.getElementById('deleteProductName').textContent = `"${productName}"`;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    // Close delete modal
    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
        productToDelete = null;
    }

    // Delete product
    function deleteProduct() {
        if (productToDelete !== null) {
            fetch(`/delete-product/${productToDelete}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response;
                })
                .then(() => {
                    const listingItem = document.querySelector(`.listing-item[data-id="${productToDelete}"]`);
                    
                    // Update status
                    listingItem.dataset.status = 'deleted';
                    const statusBadge = listingItem.querySelector('.listing-status');
                    statusBadge.textContent = 'Deleted';
                    statusBadge.classList.remove('status-active');
                    statusBadge.classList.add('status-deleted');
                    
                    // Update actions
                    const actionsDiv = listingItem.querySelector('.listing-actions');
                    actionsDiv.innerHTML = `
                        <button class="btn-restore" onclick="restoreProduct(${productToDelete})">
                            üîÑ Restore Product
                        </button>
                    `;
                    
                    showNotification('Product deleted successfully! You can restore it anytime.', 'success');
                    
                    // Re-apply current filter
                    if (currentFilter === 'active') {
                        listingItem.style.display = 'none';
                    }
                    
                    closeDeleteModal();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete product. Please try again.');
                    closeDeleteModal();
                });
        }
    }

    // Restore product
    function restoreProduct(productId) {
        fetch(`/restore-product/${productId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response;
            })
            .then(() => {
                const listingItem = document.querySelector(`.listing-item[data-id="${productId}"]`);
                
                // Update status
                listingItem.dataset.status = 'active';
                const statusBadge = listingItem.querySelector('.listing-status');
                statusBadge.textContent = 'Active';
                statusBadge.classList.remove('status-deleted');
                statusBadge.classList.add('status-active');
                
                // Get product title for the view link
                const productTitle = listingItem.querySelector('h3').textContent;
                
                // Update actions
                const actionsDiv = listingItem.querySelector('.listing-actions');
                actionsDiv.innerHTML = `
                    <a href="/product/${productId}" class="btn-view">
                        üëÅÔ∏è View Details
                    </a>
                    <a href="/edit-product/${productId}" class="btn-edit">
                        ‚úèÔ∏è Edit Product
                    </a>
                    <button class="btn-delete" onclick="confirmDelete(${productId}, '${productTitle}')">
                        üóëÔ∏è Delete Listing
                    </button>
                `;
                
                showNotification('Product restored successfully!', 'success');
                
                // Re-apply current filter
                if (currentFilter === 'deleted') {
                    listingItem.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to restore product. Please try again.');
            });
    }

    // Show notification
    function showNotification(message, type = 'success') {
        const popup = document.getElementById('notificationPopup');
        const text = document.getElementById('notificationText');
        const content = popup.querySelector('.notification-content');
        
        text.textContent = message;
        
        // Update color based on type
        if (type === 'success') {
            content.style.background = '#4CAF50';
        } else if (type === 'error') {
            content.style.background = '#f44336';
        }
        
        popup.style.display = 'flex';
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
            closeNotification();
        }, 3000);
    }

    // Close notification
    function closeNotification() {
        document.getElementById('notificationPopup').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('deleteModal');
        if (event.target === modal) {
            closeDeleteModal();
        }
    }
</script>
{% endblock %}
{% endblock %}
