commands:
  01_install_postgresql:
    command: "sudo amazon-linux-extras enable postgresql14 && sudo yum clean metadata && sudo yum install -y postgresql-server postgresql-contrib"
    ignoreErrors: false
  02_init_postgresql:
    command: "sudo /usr/bin/postgresql-setup --initdb"
    test: "[ ! -d /var/lib/pgsql/data/base ]"
  03_configure_pg_hba:
    command: |
      sudo bash -c "cat > /var/lib/pgsql/data/pg_hba.conf << 'EOF'
      local   all             all                                     md5
      host    all             all             127.0.0.1/32            md5
      host    all             all             ::1/128                 md5
      EOF"
    test: "[ -f /var/lib/pgsql/data/pg_hba.conf ]"
  04_start_postgresql:
    command: "sudo systemctl start postgresql"
  05_enable_postgresql:
    command: "sudo systemctl enable postgresql"
  06_create_database:
    command: |
      sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname = 'thrift'" | grep -q 1 || sudo -u postgres psql -c "CREATE DATABASE thrift;"
      sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'mandeepsingh';"
      sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE thrift TO postgres;"