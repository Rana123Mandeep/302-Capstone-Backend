{% extends "layout.html" %}

{% block title %}My Wishlist - Marketplace{% endblock %}

{% block content %}
<div class="wishlist-container">
    <div class="wishlist-header">
        <h1>Your Wishlist</h1>
        <p class="wishlist-count">{{ products|length }} item{% if products|length != 1 %}s{% endif %} in your wishlist</p>
    </div>

    {% if products %}
        <div class="wishlist-grid">
            {% for product in products %}
                <div class="wishlist-item" data-id="{{ product.id }}">
                    <a href="{{ url_for('product_detail', product_id=product.id) }}" class="product-image-link">
                        <img src="{{ url_for('static', filename='uploads/' + product.image_filename) }}" alt="{{ product.title }}">
                    </a>
                    <div class="wishlist-item-info">
                        <h3 class="product-name">{{ product.title }}</h3>
                        <p class="product-price">${{ "%.2f"|format(product.price) }}</p>
                        <p class="product-category">{{ product.category }}</p>
                        <div class="primary-action">
                            <a href="{{ url_for('contact_seller', product_id=product.id) }}" class="btn btn-primary">Contact Seller</a>
                        </div>
                        <div class="wishlist-actions">
                            <button class="btn-remove" onclick="removeFromWishlist({{ product.id }})">Remove</button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-wishlist">
            <div class="empty-icon">üíî</div>
            <h2>Your wishlist is empty</h2>
            <p>Start adding items you love to see them here!</p>
            <a href="{{ url_for('products') }}" class="btn btn-primary">Browse Products</a>
        </div>
    {% endif %}
</div>

<!-- Notification Popup -->
<div id="notification-popup" class="notification-popup" style="display: none;">
    <div class="notification-content">
        <span class="notification-icon" id="notificationIcon">üóëÔ∏è</span>
        <span class="notification-text" id="notificationText">Item removed from wishlist!</span>
        <span class="close-notification" onclick="closeNotification()">‚úï</span>
    </div>
</div>

{% block scripts %}
<script>
    function removeFromWishlist(productId) {
        if (confirm('Are you sure you want to remove this item from your wishlist?')) {
            fetch(`/toggle-wishlist/${productId}?ajax=1`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove item from DOM
                    const wishlistItem = document.querySelector(`.wishlist-item[data-id="${productId}"]`);
                    wishlistItem.style.opacity = '0';
                    setTimeout(() => {
                        wishlistItem.remove();
                        
                        // Update count
                        const count = document.querySelectorAll('.wishlist-item').length;
                        const countEl = document.querySelector('.wishlist-count');
                        countEl.textContent = `${count} item${count !== 1 ? 's' : ''} in your wishlist`;
                        
                        // Show empty state if no items left
                        if (count === 0) {
                            const grid = document.querySelector('.wishlist-grid');
                            grid.innerHTML = `
                                <div class="empty-wishlist">
                                    <div class="empty-icon">üíî</div>
                                    <h2>Your wishlist is empty</h2>
                                    <p>Start adding items you love to see them here!</p>
                                    <a href="{{ url_for('products') }}" class="btn btn-primary">Browse Products</a>
                                </div>
                            `;
                        }
                    }, 300);
                    
                    showNotification('Item removed from wishlist!');
                } else {
                    alert(data.message || 'Failed to remove from wishlist');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating wishlist');
            });
        }
    }
    
    function showNotification(message) {
        const popup = document.getElementById('notification-popup');
        const text = document.getElementById('notificationText');
        text.textContent = message;
        popup.style.display = 'flex';
        
        setTimeout(() => {
            closeNotification();
        }, 3000);
    }
    
    function closeNotification() {
        const popup = document.getElementById('notification-popup');
        popup.style.display = 'none';
    }
</script>
{% endblock %}
{% endblock %}
