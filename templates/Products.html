
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketplace</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-left">
      <h2>Marketplace</h2>
      <!-- Search Bar -->
  <div class="search-bar">
  <form action="{{ url_for('search') }}" method="get">
    <input type="text" name="q" id="searchInput" placeholder="Search products...">
    <button type="submit">Search</button>
  </form>
</div>

      <!-- Sell Button -->
      <a href="{{ url_for('upload') }}" class="btn">Sell</a> <!-- Updated to navigate to the upload page -->
       <!-- Your Listings Button -->
      <a href="{{ url_for('YourListing') }}" class="btn">Your Listings</a>
        <div class="categories-dropdown" id="categoriesDropdown">
        <button class="btn active" id="categoriesBtn" onclick="toggleCategories()">Categories ‚ñº</button>
        <div class="categories-menu" id="categoriesMenu">
         <div class="filter-section">
  <h4>Filter by Category</h4>
  <select id="categoryFilter" onchange="filterCategory(this.value)">
    <option value="{{ url_for('all_categories') }}">All Categories</option>
    <option value="{{ url_for('category', category_name='electronics') }}">Electronics</option>
    <option value="{{ url_for('category', category_name='clothing') }}">Clothing</option>
    <option value="{{ url_for('category', category_name='fashion') }}">Fashion</option>
    <option value="{{ url_for('category', category_name='books') }}">Books</option>
    <option value="{{ url_for('category', category_name='car') }}">Car</option>
  </select>
</div>

<script>
  function filterCategory(url) {
    window.location.href = url;
  }
</script>

    <div class="nav-right">
      <!-- Wishlist Icon -->
    <a href="{{ url_for('wishlist') }}" class="wishlist-icon" title="View Wishlist">‚ù§Ô∏è</a>
      <!-- Customer Support Icon -->
      <a href="{{ url_for('customer_support') }}" class="support-icon" title="Customer Support">üÜò</a>
    
    <div class="nav-right">
      <div class="user-icon-container">
        <span class="user-icon" onclick="toggleLogout()" title="Click to show logout option">üë§</span>
        <span class="logout-text" id="logoutText" onclick="logout()" style="display: none;">Logout</span>
      </div>
    </div>
  </nav>
  </nav>
  {% if message %}
  <p style="text-align:center; color: red; font-weight: bold; margin-top: 20px;"><!--this line depicts the messge if search item not found -->
    {{ message }}
  </p>
{% endif %}
  <!-- Products Grid -->
  <div class="products">
    {% for product in products %}
    <div class="product">
    <a href="{{ url_for('item_message', item_id=product.id) }}" class="product-image-link"> <!--This link uplate the iamge and product details in itemmessage.html-->

      <img src="{{ url_for('static', filename='uploads/' ~ product.image_filename) }}" alt="{{ product.Producttitle }}" 
      </a>
      <div class="product-info">
        <p class="product-name">{{ product. Producttitle }}</p>
        <p class="product-price">${{ product.price }}</p> <!-- Added $ before product.price -->
        
      </div>
    </div>
    {% endfor %}
  </div>

  <script>
     let searchTimeout;
    let allProducts = [];
    
    // Store original products on page load
    document.addEventListener('DOMContentLoaded', function() {
      const productElements = document.querySelectorAll('.product');
      allProducts = Array.from(productElements).map((element, index) => ({
        element: element,
        name: element.dataset.name,
        category: element.dataset.category,
        price: parseFloat(element.dataset.price),
        features: element.dataset.features,
        condition: element.dataset.condition || 'good',
        index: index
      }));
    });
    
    function toggleUserMenu() {
      const userMenu = document.getElementById('userMenu');
      const userIcon = document.querySelector('.user-icon');
      
      userMenu.classList.toggle('active');
      
      if (userMenu.classList.contains('active')) {
        userIcon.classList.add('active');
      } else {
        userIcon.classList.remove('active');
      }
    }
    
    function closeUserMenu() {
      const userMenu = document.getElementById('userMenu');
      const userIcon = document.querySelector('.user-icon');
      
      userMenu.classList.remove('active');
      userIcon.classList.remove('active');
    }
    
    function viewProfile() {
      // Add profile functionality here
      alert('Profile page coming soon!');
      closeUserMenu();
    }
    
    function viewSettings() {
      // Add settings functionality here
      alert('Settings page coming soon!');
      closeUserMenu();
    }
    
    function logout() {
      window.location.href = "{{ url_for('logout') }}";
    }
    
    function toggleCategories() {
      const categoriesMenu = document.getElementById('categoriesMenu');
      const categoriesBtn = document.getElementById('categoriesBtn');
      
      categoriesMenu.classList.toggle('active');
      
      if (categoriesMenu.classList.contains('active')) {
        categoriesBtn.textContent = 'Categories ‚ñ≤';
        categoriesBtn.classList.add('filter-active');
      } else {
        categoriesBtn.textContent = 'Categories ‚ñº';
        categoriesBtn.classList.remove('filter-active');
      }
    }
    
    function closeCategories() {
      const categoriesMenu = document.getElementById('categoriesMenu');
      const categoriesBtn = document.getElementById('categoriesBtn');
      
      categoriesMenu.classList.remove('active');
      categoriesBtn.textContent = 'Categories ‚ñº';
      categoriesBtn.classList.remove('filter-active');
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      const categoriesDropdown = document.getElementById('categoriesDropdown');
      const categoriesMenu = document.getElementById('categoriesMenu');
      const userDropdown = document.getElementById('userDropdown');
      const userMenu = document.getElementById('userMenu');
      
      // Close categories dropdown
      if (!categoriesDropdown.contains(event.target) && categoriesMenu.classList.contains('active')) {
        closeCategories();
      }
      
      // Close user dropdown
      if (!userDropdown.contains(event.target) && userMenu.classList.contains('active')) {
        closeUserMenu();
      }
    });
    function filterCategory() {
  const selected = document.getElementById("categoryFilter").value;
  
  // Redirect to the correct route
  if (selected === "") {
    window.location.href = "/category/";  // all categories
  } else {
    window.location.href = "/category/" + selected;  // specific category
  }
}
    //this function help to navigate the browser page imp.
function filterCategory(url) {
  window.location.href = url;
}
    function performSearch() {
      // Clear previous timeout
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      // Debounce search for better performance
      searchTimeout = setTimeout(() => {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        const category = document.getElementById('categoryFilter').value.toLowerCase();
        const condition = document.getElementById('conditionFilter').value.toLowerCase();
        const minPrice = document.getElementById('minPrice').value;
        const maxPrice = document.getElementById('maxPrice').value;
        
        // Show/hide clear button
        const clearBtn = document.getElementById('clearSearch');
        clearBtn.style.display = searchTerm ? 'inline' : 'none';
        
        // Filter products
        let filteredProducts = allProducts.filter(product => {
          // Text search
          if (searchTerm) {
            const searchableText = `${product.name} ${product.category} ${product.features}`;
            if (!searchableText.includes(searchTerm)) {
              return false;
            }
          }
          
          // Category filter
          if (category && category !== product.category) {
            return false;
          }
          
          // Condition filter
          if (condition && condition !== product.condition) {
            return false;
          }
          
          // Price range filter
          if (minPrice && product.price < parseFloat(minPrice)) {
            return false;
          }
          if (maxPrice && product.price > parseFloat(maxPrice)) {
            return false;
          }
          
          return true;
        });
        
        // Update display
        updateProductDisplay(filteredProducts, searchTerm, category, condition, minPrice, maxPrice);
        
      }, 300); // 300ms delay for better UX
    }
    
    function updateProductDisplay(filteredProducts, searchTerm, category, condition, minPrice, maxPrice) {
      const container = document.getElementById('productsContainer');
      const noResults = document.getElementById('noResults');
      const searchInfo = document.getElementById('searchInfo');
      
      // Hide all products first
      allProducts.forEach(product => {
        product.element.style.display = 'none';
      });
      
      // Show filtered products
      filteredProducts.forEach(product => {
        product.element.style.display = 'flex';
      });
      
      // Update search info
      let searchInfoText = '';
      if (searchTerm || category || condition || minPrice || maxPrice) {
        const totalProducts = allProducts.length;
        const foundProducts = filteredProducts.length;
        
        searchInfoText = `Showing ${foundProducts} of ${totalProducts} products`;
        
        if (searchTerm) searchInfoText += ` for "${searchTerm}"`;
        if (category) searchInfoText += ` in ${category.charAt(0).toUpperCase() + category.slice(1)}`;
        if (condition) searchInfoText += ` (${condition.charAt(0).toUpperCase() + condition.slice(1)} condition)`;
        if (minPrice || maxPrice) {
          searchInfoText += ` ($${minPrice || '0'} - $${maxPrice || '‚àû'})`;
        }
        
        searchInfo.textContent = searchInfoText;
        searchInfo.style.display = 'block';
      } else {
        searchInfo.style.display = 'none';
      }
      
      // Show/hide no results message
      if (filteredProducts.length === 0 && (searchTerm || category || condition || minPrice || maxPrice)) {
        noResults.style.display = 'block';
        container.style.display = 'none';
      } else {
        noResults.style.display = 'none';
        container.style.display = 'grid';
      }
    }
    
    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('categoryFilter').value = '';
      document.getElementById('conditionFilter').value = '';
      document.getElementById('minPrice').value = '';
      document.getElementById('maxPrice').value = '';
      document.getElementById('clearSearch').style.display = 'none';
      
      // Show all products
      allProducts.forEach(product => {
        product.element.style.display = 'flex';
      });
      
      // Hide search info and no results
      document.getElementById('searchInfo').style.display = 'none';
      document.getElementById('noResults').style.display = 'none';
      document.getElementById('productsContainer').style.display = 'grid';
    }
    
    function applyFilters() {
      performSearch();
      closeCategories();
    }
    
    function clearFilters() {
      document.getElementById('categoryFilter').value = '';
      document.getElementById('conditionFilter').value = '';
      document.getElementById('minPrice').value = '';
      document.getElementById('maxPrice').value = '';
      performSearch();
    }
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Focus search on Ctrl+F or Cmd+F
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById('searchInput').focus();
      }
      
      // Clear search on Escape
      if (e.key === 'Escape') {
        clearSearch();
      }
    });
    
    // Auto-focus search input
    document.getElementById('searchInput').addEventListener('focus', function() {
      this.select(); // Select all text when focused
    });
//     function filterCategory() {
//     var category = document.getElementById("categoryFilter").value;
//     if(category) {
//         window.location.href = "/category/" + category;
//     } else {
//         window.location.href = "/products"; // show all products
//     }
// }

    
  </script>
</body>
</html>
